var Product = require('../models/product.js');

module.exports = {
    index: function(req, res) {
        Product.find({}, function (err, products) {
            if (err) {
                res.json(err);
            }
            else {
                res.json({message: "Show all products!", products});
            }
        })
    },
    showProduct: function(req, res) {
        Product.findOne({ _id: req.params.id }, function (err, product) {
            if (err) {
                res.json(err);
            }
            else {
                res.json({message: "Show product!", product});
            }
        })
    },
    newProduct: function(req, res) {
        var product = new Product({ title: req.body.title, price: req.body.price, url: req.body.url });
        var arr = [];
        if (req.body.url.length === 0) {
            product.url = "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/1024px-No_image_available.svg.png"
        }
        product.save(function (err,savedProduct) {
            if (err){
                console.log("We have an error!", err);
                for(var key in err.errors){
                    arr.push(err.errors[key].message);
                }
                res.json({msgError:arr, savedProduct});
            }
            else {
                res.json({message: "Added product!", savedProduct});
            }
        })
    },
    editProduct: function(req, res) {
        var arr = [];
        Product.findOne({ _id: req.params.id }, function (err, product) {
            if (err){
                res.json(err);
            }
            else {
                if(req.body.title.length < 4){
                    arr.push("Title must be at least 4 characters")
                }
                if(req.body.price.length < 1){
                    arr.push("Price must be filled out")
                }
                if (req.body.title){
                    product.title = req.body.title;
                }
                if (req.body.price){
                    product.price = req.body.price;
                }
                if (req.body.url != null && req.body.url != ""){
                    product.url = req.body.url;
                } else {
                    product.url = "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/1024px-No_image_available.svg.png"
                }
                if(arr.length > 0){
                    res.json({msgError:arr});
                }else {
                    product.save(function (err, editProduct){
                        if (err) {
                            res.json(err);
                        }
                        else {
                            res.json({message: "Edited product!", editProduct});
                        }
                    })
                }
            }
        })
    },
    removeProduct: function(req, res) {
        Product.remove({ _id: req.params.id }, function (err, deleteProduct) {
            if (err) {
                res.json(err);
            }
            else {
                res.json({message: "Removed product!", removedProduct: deleteProduct});
            }
        })
    },
}